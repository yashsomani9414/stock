<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S&P 500 Market Screener</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/style.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.dataTables.min.css">
</head>

<body>
    <header class="app-header">
        <div class="header-content">
            <div class="logo-group">
                <div class="logo-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="1" x2="12" y2="23"></line>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>
                </div>
                <div>
                    <div class="app-title">S&P 500 Screener</div>
                    <div class="app-subtitle">Real-time Technicals & Fundamentals</div>
                </div>
            </div>

            <nav class="header-nav">
                <a href="/" class="nav-link active">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="8" y1="6" x2="21" y2="6"></line>
                        <line x1="8" y1="12" x2="21" y2="12"></line>
                        <line x1="8" y1="18" x2="21" y2="18"></line>
                        <line x1="3" y1="6" x2="3.01" y2="6"></line>
                        <line x1="3" y1="12" x2="3.01" y2="12"></line>
                        <line x1="3" y1="18" x2="3.01" y2="18"></line>
                    </svg>
                    Screener
                </a>
                <a href="/sector" class="nav-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                        <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                    </svg>
                    Sector Analysis
                </a>
            </nav>

            <button id="fetchBtn" class="action-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 2v6h-6"></path>
                    <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
                    <path d="M3 22v-6h6"></path>
                    <path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path>
                </svg>
                Refresh Data
            </button>
        </div>
    </header>

    <main class="main-content">
        <div class="controls-bar">
            <!-- Custom Search Box location (we will move DataTables search here) -->
            <div id="customSearchContainer" class="search-container"></div>

            <!-- Stock Count Display -->
            <div id="stockCountDisplay" class="stock-count-badge">
                Showing <span id="visibleCount">0</span> / <span id="totalCount">0</span> Stocks
            </div>

            <div id="status" class="status-msg"></div>
        </div>

        <div class="dashboard-container">
            <!-- Left Panel: Table -->
            <div class="table-panel">
                <table id="screenerTable" class="display responsive nowrap" style="width:100%">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Price</th>
                            <th>50D MA</th>
                            <th>200D MA</th>
                            <th>Trend Strength</th>
                            <th>5D Ret</th>
                            <th>1M Ret</th>
                            <th>6M Ret</th>
                            <th>P/E</th>
                            <th>Mkt Cap</th>
                            <th>Sector</th>
                            <th>Industry</th>
                            <th>Company Name</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Right Panel: Chart & News -->
            <div id="chartPanel" class="chart-panel">
                <div class="chart-header">
                    <h3 id="chartTitle">Select a Stock</h3>
                </div>
                <div class="chart-body">
                    <canvas id="stockChart"></canvas>
                </div>
                <div id="chartLoader" class="text-center"
                    style="display:none; color:var(--text-secondary); padding: 20px;">
                    Loading Chart...
                </div>

                <!-- Integrated News Section -->
                <div class="panel-news-section"
                    style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-subtle);">
                    <h4
                        style="margin-bottom: 16px; font-size: 14px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em;">
                        Recent News</h4>
                    <div id="panelNewsLoader" style="display:none; color:var(--text-muted); font-size:13px;">Loading
                        news...</div>
                    <div id="panelNewsList" class="panel-news-list">
                        <!-- News items injected here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="app-footer">
        <p>Data provided by Yahoo Finance & Google News. For educational purposes only.</p>
    </footer>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        $(document).ready(function () {
            let chartInstance = null;

            const table = $('#screenerTable').DataTable({
                responsive: true,
                dom: '<"top-controls"f>rt<"bottom-controls"lip>',
                columns: [
                    {
                        data: 'Symbol',
                        render: function (data, type, row) {
                            return `<div style="display:flex; flex-direction:column;">
                                    <span class="font-bold symbol-link" style="color:var(--accent-blue); cursor:pointer;">${data}</span>
                                    <span style="font-size:11px; color:var(--text-muted);">${row.Name || ''}</span>
                                  </div>`;
                        }
                    },
                    { data: 'Price', render: $.fn.dataTable.render.number(',', '.', 2, '$') },
                    { data: '50D MA', render: $.fn.dataTable.render.number(',', '.', 2, '$') },
                    { data: '200D MA', render: $.fn.dataTable.render.number(',', '.', 2, '$') },
                    {
                        data: 'Trend Strength',
                        render: function (data) {
                            if (data === null) return 'N/A';
                            const colorClass = data >= 0 ? 'text-bullish' : 'text-bearish';
                            const icon = data >= 0 ? '▲' : '▼';
                            return `<span class="${colorClass} font-bold">${icon} ${data}%</span>`;
                        }
                    },
                    {
                        data: '5D Return',
                        render: function (data) {
                            if (data === null) return 'N/A';
                            return `<span class="${data >= 0 ? 'text-bullish' : 'text-bearish'}">${data}%</span>`;
                        }
                    },
                    {
                        data: '1M Return',
                        render: function (data) {
                            if (data === null) return 'N/A';
                            return `<span class="${data >= 0 ? 'text-bullish' : 'text-bearish'}">${data}%</span>`;
                        }
                    },
                    {
                        data: '6M Return',
                        render: function (data) {
                            if (data === null) return 'N/A';
                            return `<span class="${data >= 0 ? 'text-bullish' : 'text-bearish'}">${data}%</span>`;
                        }
                    },
                    { data: 'P/E Ratio' },
                    {
                        data: 'Market Cap',
                        render: function (data) {
                            if (!data) return 'N/A';
                            if (data >= 1e12) return (data / 1e12).toFixed(2) + 'T';
                            if (data >= 1e9) return (data / 1e9).toFixed(2) + 'B';
                            if (data >= 1e6) return (data / 1e6).toFixed(2) + 'M';
                            return data;
                        }
                    },
                    { data: 'Sector' },
                    { data: 'Industry' },
                    { data: 'Name', visible: false }
                ],
                order: [[4, 'desc']],
                pageLength: 25,
                language: {
                    emptyTable: "No data available. Click 'Refresh Data' to fetch.",
                    search: "_INPUT_",
                    searchPlaceholder: "Search Ticker or Company..."
                },
                select: true,
                drawCallback: function (settings) {
                    const api = this.api();
                    const info = api.page.info();
                    $('#visibleCount').text(info.recordsDisplay);
                    $('#totalCount').text(info.recordsTotal);
                }
            });

            // Move DataTables search to our custom container for better control/visibility
            $('#screenerTable_filter').appendTo('#customSearchContainer');

            // Handle Row/Symbol Click
            $('#screenerTable tbody').on('click', 'tr', function () {
                const data = table.row(this).data();
                if (data) {
                    loadChart(data.Symbol);
                    loadNews(data.Symbol);

                    // Open Side Panel handling handled by CSS layout, just ensure it's visible
                    $('.dashboard-container').addClass('panel-open');
                }
            });

            function loadNews(symbol) {
                $('#panelNewsList').empty();
                $('#panelNewsLoader').show();

                fetch(`/api/news/${symbol}`)
                    .then(r => r.json())
                    .then(data => {
                        $('#panelNewsLoader').hide();
                        if (!data || data.length === 0) {
                            $('#panelNewsList').html('<div style="color:var(--text-muted); font-size:13px;">No recent news found via Google News.</div>');
                            return;
                        }

                        // Take top 5
                        const items = data.slice(0, 5);
                        items.forEach(item => {
                            // Google News Item: { title, link, pubDate, source }
                            const dateStr = item.pubDate ? new Date(item.pubDate).toLocaleDateString() : '';
                            const div = document.createElement('div');
                            div.className = 'panel-news-item';
                            div.innerHTML = `
                                <a href="${item.link}" target="_blank" class="panel-news-link">
                                    <div class="panel-news-title">${item.title}</div>
                                    <div class="panel-news-meta">
                                        <span class="panel-news-source">${item.source}</span>
                                        <span>${dateStr}</span>
                                    </div>
                                </a>
                            `;
                            $('#panelNewsList').append(div);
                        });
                    })
                    .catch(e => {
                        console.error(e);
                        $('#panelNewsLoader').hide();
                        $('#panelNewsList').html('<div style="color:var(--bearish); font-size:13px;">Error loading news.</div>');
                    });
            }

            function loadChart(symbol) {
                $('#chartTitle').text(symbol + ' Daily Chart');
                $('#chartLoader').show();

                if (chartInstance) {
                    chartInstance.destroy();
                }

                fetch(`/api/history/${symbol}`)
                    .then(r => r.json())
                    .then(data => {
                        $('#chartLoader').hide();
                        if (data.error || !data.prices || data.prices.length === 0) {
                            // Handle error
                            return;
                        }

                        const ctx = document.getElementById('stockChart').getContext('2d');

                        // Gradient Fill
                        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                        gradient.addColorStop(0, 'rgba(99, 102, 241, 0.5)');
                        gradient.addColorStop(1, 'rgba(99, 102, 241, 0.0)');

                        chartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: data.dates,
                                datasets: [{
                                    label: 'Price',
                                    data: data.prices,
                                    borderColor: '#6366f1',
                                    backgroundColor: gradient,
                                    borderWidth: 2,
                                    fill: true,
                                    pointRadius: 0,
                                    pointHoverRadius: 4,
                                    tension: 0.1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    mode: 'index',
                                    intersect: false,
                                },
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        callbacks: {
                                            title: function (context) {
                                                return context[0].label; // Show full date in tooltip
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true, // Show dates on X axis
                                        ticks: {
                                            maxTicksLimit: 6, // Limit number of labels to avoid clutter
                                            color: '#64748b'
                                        },
                                        grid: { display: false }
                                    },
                                    y: {
                                        grid: { color: 'rgba(255,255,255,0.05)' },
                                        ticks: { color: '#94a3b8' }
                                    }
                                }
                            }
                        });
                    })
                    .catch(e => {
                        console.error(e);
                        $('#chartLoader').html('<span style="color:var(--bearish)">Error loading chart.</span>');
                    });
            }

            function loadData(forceRefresh = false) {
                const btn = $('#fetchBtn');
                const originalText = btn.html();

                btn.prop('disabled', true).html('<span class="loader-ring small" style="width:16px;height:16px;border-width:2px;display:inline-block;margin-right:8px;"></span> Loading...');
                $('#status').html('<div style="color:var(--text-accent)">Checking/Fetching stock data...</div>');

                fetch(`/api/data?refresh=${forceRefresh}`)
                    .then(response => response.json())
                    .then(data => {
                        table.clear();
                        if (data.length > 0) {
                            table.rows.add(data).draw();
                            $('#status').html(`<div style="color:var(--bullish)">Loaded ${data.length} stocks. Select a stock to view chart.</div>`);
                        } else {
                            $('#status').html('<div style="color:var(--text-muted)">No data found. Click "Refresh Data" to fetch from Yahoo.</div>');
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        $('#status').html('<div style="color:var(--bearish)">Error fetching data. Check logs.</div>');
                    })
                    .finally(() => {
                        btn.prop('disabled', false).html(originalText);
                    });
            }

            // Initial load (cached only, will be empty if new session and no cache file)
            loadData(false);

            $('#fetchBtn').click(function () {
                loadData(true);
            });
        });
    </script>
</body>

</html>